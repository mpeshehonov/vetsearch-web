-- Простая загрузка тестовых данных в правильном порядке

-- 1. Услуги (не зависят от других таблиц)
INSERT INTO services (id, name, description, category, price, duration_minutes, is_active) VALUES
('550e8400-e29b-41d4-a716-446655440001', 'Общий осмотр', 'Комплексный осмотр животного', 'Диагностика', 1500, 30, true),
('550e8400-e29b-41d4-a716-446655440002', 'Вакцинация', 'Профилактическая вакцинация', 'Профилактика', 2000, 20, true),
('550e8400-e29b-41d4-a716-446655440003', 'Стерилизация кошек', 'Хирургическая стерилизация', 'Хирургия', 8000, 120, true),
('550e8400-e29b-41d4-a716-446655440004', 'Кастрация собак', 'Хирургическая кастрация', 'Хирургия', 10000, 90, true),
('550e8400-e29b-41d4-a716-446655440005', 'Чистка зубов', 'Профессиональная чистка зубов', 'Стоматология', 3500, 45, true);

-- 2. Клиники (зависят от cities)
INSERT INTO clinics (id, name, description, address, phone, email, website, city_id, latitude, longitude, rating, reviews_count, is_active, working_hours) VALUES
('660e8400-e29b-41d4-a716-446655440001', 'ВетЦентр Здоровье', 'Современная ветеринарная клиника с полным спектром услуг', 'ул. Ленина, 15', '+7 (495) 123-45-67', 'info@vetzdorovie.ru', 'https://vetzdorovie.ru', (SELECT id FROM cities WHERE name = 'Москва' LIMIT 1), 55.7558, 37.6176, 4.8, 156, true, '{"пн-пт": "8:00-20:00", "сб": "9:00-18:00", "вс": "10:00-16:00"}'),
('660e8400-e29b-41d4-a716-446655440002', 'Айболит Плюс', 'Ветеринарная клиника с опытными специалистами', 'пр. Невский, 88', '+7 (812) 987-65-43', 'contact@aibolit-plus.ru', 'https://aibolit-plus.ru', (SELECT id FROM cities WHERE name = 'Санкт-Петербург' LIMIT 1), 59.9311, 30.3609, 4.6, 89, true, '{"пн-сб": "9:00-21:00", "вс": "10:00-18:00"}'),
('660e8400-e29b-41d4-a716-446655440003', 'Четыре Лапы', 'Семейная ветеринарная клиника', 'ул. Красная, 45', '+7 (861) 555-12-34', 'info@4lapy-krd.ru', null, (SELECT id FROM cities WHERE name = 'Краснодар' LIMIT 1), 45.0355, 38.9753, 4.7, 67, true, '{"пн-пт": "8:30-19:30", "сб-вс": "9:00-17:00"}');

-- 3. Профили ветеринаров
INSERT INTO profiles (id, full_name, email, phone, role, specialization, license_number, is_active) VALUES
('770e8400-e29b-41d4-a716-446655440001', 'Иванова Анна Сергеевна', 'a.ivanova@vetzdorovie.ru', '+7 (495) 123-45-68', 'veterinarian', 'Терапевт', 'ВЕТ-12345', true),
('770e8400-e29b-41d4-a716-446655440002', 'Петров Михаил Александрович', 'm.petrov@vetzdorovie.ru', '+7 (495) 123-45-69', 'veterinarian', 'Хирург', 'ВЕТ-12346', true),
('770e8400-e29b-41d4-a716-446655440003', 'Сидорова Елена Викторовна', 'e.sidorova@aibolit-plus.ru', '+7 (812) 987-65-44', 'veterinarian', 'Дерматолог', 'ВЕТ-12347', true),
('770e8400-e29b-41d4-a716-446655440004', 'Козлов Дмитрий Иванович', 'd.kozlov@4lapy-krd.ru', '+7 (861) 555-12-35', 'veterinarian', 'Кардиолог', 'ВЕТ-12348', true);

-- 4. Связь клиник и ветеринаров
INSERT INTO clinic_veterinarians (id, clinic_id, veterinarian_id, is_primary) VALUES
('880e8400-e29b-41d4-a716-446655440001', '660e8400-e29b-41d4-a716-446655440001', '770e8400-e29b-41d4-a716-446655440001', true),
('880e8400-e29b-41d4-a716-446655440002', '660e8400-e29b-41d4-a716-446655440001', '770e8400-e29b-41d4-a716-446655440002', false),
('880e8400-e29b-41d4-a716-446655440003', '660e8400-e29b-41d4-a716-446655440002', '770e8400-e29b-41d4-a716-446655440003', true),
('880e8400-e29b-41d4-a716-446655440004', '660e8400-e29b-41d4-a716-446655440003', '770e8400-e29b-41d4-a716-446655440004', true);

-- 5. Связь клиник и услуг
INSERT INTO clinic_services (id, clinic_id, service_id, price, is_available) VALUES
('990e8400-e29b-41d4-a716-446655440001', '660e8400-e29b-41d4-a716-446655440001', '550e8400-e29b-41d4-a716-446655440001', 1500, true),
('990e8400-e29b-41d4-a716-446655440002', '660e8400-e29b-41d4-a716-446655440001', '550e8400-e29b-41d4-a716-446655440002', 2000, true),
('990e8400-e29b-41d4-a716-446655440003', '660e8400-e29b-41d4-a716-446655440001', '550e8400-e29b-41d4-a716-446655440003', 8000, true),
('990e8400-e29b-41d4-a716-446655440004', '660e8400-e29b-41d4-a716-446655440002', '550e8400-e29b-41d4-a716-446655440001', 1600, true),
('990e8400-e29b-41d4-a716-446655440005', '660e8400-e29b-41d4-a716-446655440002', '550e8400-e29b-41d4-a716-446655440005', 3500, true);

-- 6. Владельцы животных
INSERT INTO pet_owners (id, full_name, email, phone, address, emergency_contact) VALUES
('aa0e8400-e29b-41d4-a716-446655440001', 'Смирнов Алексей Петрович', 'a.smirnov@email.ru', '+7 (495) 111-22-33', 'г. Москва, ул. Тверская, 10, кв. 25', '+7 (495) 111-22-34'),
('aa0e8400-e29b-41d4-a716-446655440002', 'Волкова Мария Ивановна', 'm.volkova@email.ru', '+7 (812) 222-33-44', 'г. Санкт-Петербург, пр. Мира, 5, кв. 12', '+7 (812) 222-33-45'),
('aa0e8400-e29b-41d4-a716-446655440003', 'Новиков Сергей Александрович', 's.novikov@email.ru', '+7 (861) 333-44-55', 'г. Краснодар, ул. Красная, 20, кв. 8', '+7 (861) 333-44-56');

-- 7. Животные
INSERT INTO pets (id, name, species, breed, gender, birth_date, weight, color, owner_id, microchip_number, allergies, medical_notes, is_active) VALUES
('bb0e8400-e29b-41d4-a716-446655440001', 'Мурка', 'Кошка', 'Британская короткошерстная', 'Женский', '2020-05-15', 4.2, 'Серый', 'aa0e8400-e29b-41d4-a716-446655440001', '123456789012345', null, 'Здоровая кошка', true),
('bb0e8400-e29b-41d4-a716-446655440002', 'Рекс', 'Собака', 'Немецкая овчарка', 'Мужской', '2019-03-10', 32.5, 'Черно-коричневый', 'aa0e8400-e29b-41d4-a716-446655440002', '987654321098765', 'Аллергия на курицу', 'Активная собака', true),
('bb0e8400-e29b-41d4-a716-446655440003', 'Пушок', 'Кролик', 'Декоративный', 'Мужской', '2021-08-20', 1.8, 'Белый', 'aa0e8400-e29b-41d4-a716-446655440003', null, null, 'Молодой кролик', true);

-- 8. Записи на прием
INSERT INTO appointments (id, pet_id, veterinarian_id, service_id, appointment_date, appointment_time, status, reason, duration_minutes, total_cost) VALUES
('cc0e8400-e29b-41d4-a716-446655440001', 'bb0e8400-e29b-41d4-a716-446655440001', '770e8400-e29b-41d4-a716-446655440001', '550e8400-e29b-41d4-a716-446655440001', '2024-01-15', '10:00', 'completed', 'Плановый осмотр', 30, 1500),
('cc0e8400-e29b-41d4-a716-446655440002', 'bb0e8400-e29b-41d4-a716-446655440002', '770e8400-e29b-41d4-a716-446655440002', '550e8400-e29b-41d4-a716-446655440004', '2024-01-20', '14:30', 'scheduled', 'Кастрация', 90, 10000),
('cc0e8400-e29b-41d4-a716-446655440003', 'bb0e8400-e29b-41d4-a716-446655440003', '770e8400-e29b-41d4-a716-446655440004', '550e8400-e29b-41d4-a716-446655440001', '2024-01-25', '16:00', 'scheduled', 'Первичный осмотр', 30, 1500);

-- 9. Отзывы
INSERT INTO reviews (id, clinic_id, veterinarian_id, author_name, author_email, rating, title, content, is_verified, is_helpful_count) VALUES
('dd0e8400-e29b-41d4-a716-446655440001', '660e8400-e29b-41d4-a716-446655440001', '770e8400-e29b-41d4-a716-446655440001', 'Алексей С.', 'a.smirnov@email.ru', 5, 'Отличный врач!', 'Доктор Иванова очень внимательно осмотрела мою кошку. Все объяснила понятно, дала хорошие рекомендации.', true, 12),
('dd0e8400-e29b-41d4-a716-446655440002', '660e8400-e29b-41d4-a716-446655440002', '770e8400-e29b-41d4-a716-446655440003', 'Мария В.', 'm.volkova@email.ru', 4, 'Хорошая клиника', 'Качественное обслуживание, но долго ждали в очереди. В целом довольны результатом.', true, 8),
('dd0e8400-e29b-41d4-a716-446655440003', '660e8400-e29b-41d4-a716-446655440003', '770e8400-e29b-41d4-a716-446655440004', 'Сергей Н.', 's.novikov@email.ru', 5, 'Спасли моего кролика!', 'Доктор Козлов быстро поставил диагноз и назначил лечение. Кролик быстро поправился. Рекомендую!', true, 15);

-- Обновляем счетчики отзывов в клиниках
UPDATE clinics SET 
  rating = (SELECT AVG(rating::numeric) FROM reviews WHERE clinic_id = clinics.id),
  reviews_count = (SELECT COUNT(*) FROM reviews WHERE clinic_id = clinics.id)
WHERE id IN (
  SELECT DISTINCT clinic_id FROM reviews WHERE clinic_id IS NOT NULL
);
